name: add-cla-user

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write

jobs:
  add-user-to-cla-list:
    if: github.event.issue.pull_request
    runs-on: ubuntu-latest
    steps:
      - name: Debug event
        run: |
          echo "Event type: ${{ github.event_name }}"
          echo "Comment body: '${{ github.event.comment.body }}'"
          echo "Commenter: ${{ github.event.comment.user.login }}"
          echo "Issue number: ${{ github.event.issue.number }}"
          echo "Is PR: ${{ github.event.issue.pull_request != null }}"

      - name: Check for command early
        id: command_check
        run: |
          COMMENT_BODY="${{ github.event.comment.body }}"
          # Trim whitespace and normalize the command
          COMMENT_BODY=$(echo "$COMMENT_BODY" | xargs)
          echo "Trimmed comment: '$COMMENT_BODY'"

          if [[ "$COMMENT_BODY" == "/approve-cla" ]]; then
            echo "Command found, proceeding..."
            echo "should_proceed=true" >> $GITHUB_OUTPUT
          else
            echo "Command not found, skipping workflow"
            echo "should_proceed=false" >> $GITHUB_OUTPUT
          fi

      - name: Get PR details
        if: steps.command_check.outputs.should_proceed == 'true'
        id: pr
        run: |
          PR_NUMBER="${{ github.event.issue.number }}"
          echo "Getting PR details for #${PR_NUMBER}"
          PR_DATA=$(gh api repos/${{ github.repository }}/pulls/$PR_NUMBER)
          AUTHOR=$(echo "$PR_DATA" | jq -r .user.login)
          echo "PR Author: $AUTHOR"
          echo "author=$AUTHOR" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout main branch
        if: steps.command_check.outputs.should_proceed == 'true'
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check authorization
        if: steps.command_check.outputs.should_proceed == 'true'
        id: check
        run: |
          COMMENTER="${{ github.event.comment.user.login }}"

          # Simple allowlist of maintainers because Running with PAT doesn't seem safe or necessary
          AUTHORIZED_USERS=("vikstrous2" "prasanna-anchorage") 

          echo "Checking if user '$COMMENTER' is authorized..."

          if [[ " ${AUTHORIZED_USERS[*]} " =~ " ${COMMENTER} " ]]; then
            echo "✅ User is in the authorized list. Proceeding."
            echo "is_maintainer=true" >> $GITHUB_OUTPUT
          else
            echo "❌ User is not authorized."
            echo "is_maintainer=false" >> $GITHUB_OUTPUT
            gh pr comment ${{ github.event.issue.number }} --body "Sorry @$COMMENTER, you are not authorized to run this command. Only maintainers can approve CLA signatures."
          fi

        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Add user to CLA file
        if: steps.command_check.outputs.should_proceed == 'true' && steps.check.outputs.is_maintainer == 'true'
        run: |
          AUTHOR_USERNAME="${{ steps.pr.outputs.author }}"
          COMMENTER="${{ github.event.comment.user.login }}"

          echo "Adding ${AUTHOR_USERNAME} to .cla-signed-users"

          # Check if user is already in the list
          if grep -q -w "$AUTHOR_USERNAME" .cla-signed-users; then
            echo "User is already in the list."
            gh pr comment ${{ github.event.issue.number }} --body "ℹ️ @${AUTHOR_USERNAME} is already in the CLA signers list."
            exit 0
          fi

          # Add user to file and sort
          (cat .cla-signed-users; echo "${AUTHOR_USERNAME}") | sort -u > .cla-signed-users.tmp
          mv .cla-signed-users.tmp .cla-signed-users

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Commit and push the change to main
          git add .cla-signed-users
          git commit -m "chore: Add @${AUTHOR_USERNAME} to CLA signers list

          Approved by: @${COMMENTER}
          Related PR: #${{ github.event.issue.number }}"
          git push origin main

          echo "✅ User added to CLA signers list on main branch"

          # Comment on PR to confirm
          gh pr comment ${{ github.event.issue.number }} --body "✅ @${AUTHOR_USERNAME} has been added to the CLA signers list by @${COMMENTER}. The CLA check should now pass on the next run."
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
