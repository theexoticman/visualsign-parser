FROM stagex/pallet-rust:sx2025.06.0@sha256:740b9ed5f2a897d45cafdc806976d84231aa50a64998610750b42a48f8daacab AS build

# Rust configuration
ENV RUSTFLAGS='-C target-feature=+crt-static'
ENV CARGOFLAGS='--target x86_64-unknown-linux-musl --no-default-features --locked --release'

# Directory for Rust artifacts
ENV RELEASE_DIR=/src/target/x86_64-unknown-linux-musl/release

# Load Rust sources
ADD src /src
WORKDIR /src/


# Configure git with secret mount (more secure)
RUN --mount=type=secret,id=github_token \
    echo "=== Checking GitHub token availability ===" && \
    if [ -f /run/secrets/github_token ]; then \
        echo "✓ Secret found, configuring git..." && \
        GITHUB_TOKEN=$(cat /run/secrets/github_token) && \
        git config --global url."https://x-access-token:${GITHUB_TOKEN}@github.com/".insteadOf "https://github.com/" && \
        echo "✓ Git configured with token"; \
    else \
        echo "✗ No GitHub token secret found" && \
        ls -la /run/secrets/ 2>/dev/null || echo "No secrets directory"; \
    fi


# pre-fetch all workspace deps; we need to them to build with `--network=none` later
RUN cargo fetch

WORKDIR /src/parser/host
RUN --network=none <<-EOF
    set -eu
    cargo build ${CARGOFLAGS} --features vsock
    mkdir -p /rootfs/usr/local/bin
    mv ${RELEASE_DIR}/parser_host /rootfs/usr/local/bin/
    ln -s /usr/local/bin/parser_host /rootfs/parser_host.linux-x86_64
EOF

FROM scratch AS package
COPY --from=build /rootfs/. .
